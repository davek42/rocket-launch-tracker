###############################################################################
# ðŸš€ Nginx Configuration for Rocket Launch Tracker
###############################################################################
#
# This configuration:
# - Serves React frontend as static files from /var/www/rocket-launches/frontend/dist
# - Proxies API requests (/api/*) to Bun backend on port 3005
# - Handles HTTP (port 80) and HTTPS (port 443) traffic
# - Implements security headers, caching, and compression
# - Supports SSL via Let's Encrypt (Certbot)
#
# Installation:
#   sudo cp deploy/nginx.conf /etc/nginx/sites-available/rocket-launches
#   sudo ln -s /etc/nginx/sites-available/rocket-launches /etc/nginx/sites-enabled/
#   sudo nginx -t
#   sudo systemctl reload nginx
#
###############################################################################

# Upstream backend server (Bun + Express)
upstream rocket_launches_backend {
    # Backend runs on localhost:3005
    server 127.0.0.1:3005;

    # Keep alive connections for better performance
    keepalive 32;
}

###############################################################################
# HTTP Server (Port 80)
###############################################################################

server {
    listen 80;
    listen [::]:80;

    server_name yourdomain.com www.yourdomain.com;

    # Server tokens off for security
    server_tokens off;

    # Max upload size (for future features)
    client_max_body_size 10M;

    # Root directory for frontend static files
    root /var/www/rocket-launches/frontend/dist;
    index index.html;

    # Access and error logs
    access_log /var/log/nginx/rocket-launches-access.log;
    error_log /var/log/nginx/rocket-launches-error.log warn;

    ###########################################################################
    # Security Headers
    ###########################################################################

    # Prevent clickjacking
    add_header X-Frame-Options "SAMEORIGIN" always;

    # Prevent MIME type sniffing
    add_header X-Content-Type-Options "nosniff" always;

    # Enable XSS protection
    add_header X-XSS-Protection "1; mode=block" always;

    # Referrer policy
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # Permissions policy (formerly Feature-Policy)
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;

    ###########################################################################
    # Gzip Compression
    ###########################################################################

    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/xml+rss
        application/rss+xml
        font/truetype
        font/opentype
        application/vnd.ms-fontobject
        image/svg+xml;

    ###########################################################################
    # API Proxy to Backend
    ###########################################################################

    location /api/ {
        # Proxy to Bun backend
        proxy_pass http://rocket_launches_backend;

        # Preserve original request information
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket support (for future features)
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        # Buffering
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;

        # Disable caching for API responses
        add_header Cache-Control "no-cache, no-store, must-revalidate" always;
        add_header Pragma "no-cache" always;
        add_header Expires "0" always;
    }

    ###########################################################################
    # Health Check Endpoint (bypasses backend)
    ###########################################################################

    location = /health {
        # Proxy to backend health check
        proxy_pass http://rocket_launches_backend/health;
        proxy_set_header Host $host;
        access_log off;
    }

    ###########################################################################
    # Static Assets (Frontend)
    ###########################################################################

    # Cache immutable assets (hashed filenames from Vite)
    location ~* ^/assets/.+\.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    # Cache images, fonts, and other media
    location ~* \.(png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|webp|avif)$ {
        expires 30d;
        add_header Cache-Control "public, max-age=2592000";
        access_log off;
    }

    # Don't cache HTML files (for SPA routing)
    location ~* \.html$ {
        expires -1;
        add_header Cache-Control "no-cache, no-store, must-revalidate" always;
    }

    ###########################################################################
    # React Router (SPA) - Serve index.html for all routes
    ###########################################################################

    location / {
        try_files $uri $uri/ /index.html;

        # Don't cache index.html
        add_header Cache-Control "no-cache, no-store, must-revalidate" always;
        add_header Pragma "no-cache" always;
        add_header Expires "0" always;
    }

    ###########################################################################
    # Security: Deny access to hidden files
    ###########################################################################

    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }

    ###########################################################################
    # Favicon and robots.txt
    ###########################################################################

    location = /favicon.ico {
        log_not_found off;
        access_log off;
    }

    location = /robots.txt {
        log_not_found off;
        access_log off;
    }
}

###############################################################################
# HTTPS Server (Port 443)
# Uncomment after running Certbot to enable SSL
###############################################################################

# server {
#     listen 443 ssl http2;
#     listen [::]:443 ssl http2;
#
#     server_name yourdomain.com www.yourdomain.com;
#
#     # SSL certificates (managed by Certbot)
#     ssl_certificate /etc/letsencrypt/live/yourdomain.com/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/yourdomain.com/privkey.pem;
#     include /etc/letsencrypt/options-ssl-nginx.conf;
#     ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
#
#     # HSTS (HTTP Strict Transport Security)
#     add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
#
#     # All other configuration same as HTTP server
#     # (Copy all locations, security headers, etc. from above)
#
#     server_tokens off;
#     client_max_body_size 10M;
#
#     root /var/www/rocket-launches/frontend/dist;
#     index index.html;
#
#     access_log /var/log/nginx/rocket-launches-access.log;
#     error_log /var/log/nginx/rocket-launches-error.log warn;
#
#     # Security Headers
#     add_header X-Frame-Options "SAMEORIGIN" always;
#     add_header X-Content-Type-Options "nosniff" always;
#     add_header X-XSS-Protection "1; mode=block" always;
#     add_header Referrer-Policy "strict-origin-when-cross-origin" always;
#     add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;
#
#     # Gzip Compression
#     gzip on;
#     gzip_vary on;
#     gzip_proxied any;
#     gzip_comp_level 6;
#     gzip_types
#         text/plain
#         text/css
#         text/xml
#         text/javascript
#         application/json
#         application/javascript
#         application/xml+rss
#         application/rss+xml
#         font/truetype
#         font/opentype
#         application/vnd.ms-fontobject
#         image/svg+xml;
#
#     # API Proxy
#     location /api/ {
#         proxy_pass http://rocket_launches_backend;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#         proxy_http_version 1.1;
#         proxy_set_header Upgrade $http_upgrade;
#         proxy_set_header Connection "upgrade";
#         proxy_connect_timeout 60s;
#         proxy_send_timeout 60s;
#         proxy_read_timeout 60s;
#         add_header Cache-Control "no-cache, no-store, must-revalidate" always;
#     }
#
#     # Health Check
#     location = /health {
#         proxy_pass http://rocket_launches_backend/health;
#         proxy_set_header Host $host;
#         access_log off;
#     }
#
#     # Static Assets
#     location ~* ^/assets/.+\.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
#         expires 1y;
#         add_header Cache-Control "public, immutable";
#         access_log off;
#     }
#
#     location ~* \.(png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|webp|avif)$ {
#         expires 30d;
#         add_header Cache-Control "public, max-age=2592000";
#         access_log off;
#     }
#
#     location ~* \.html$ {
#         expires -1;
#         add_header Cache-Control "no-cache, no-store, must-revalidate" always;
#     }
#
#     # SPA Routing
#     location / {
#         try_files $uri $uri/ /index.html;
#         add_header Cache-Control "no-cache, no-store, must-revalidate" always;
#     }
#
#     # Security
#     location ~ /\. {
#         deny all;
#         access_log off;
#         log_not_found off;
#     }
#
#     location = /favicon.ico {
#         log_not_found off;
#         access_log off;
#     }
#
#     location = /robots.txt {
#         log_not_found off;
#         access_log off;
#     }
# }

###############################################################################
# HTTP to HTTPS Redirect (uncomment after SSL setup)
###############################################################################

# server {
#     listen 80;
#     listen [::]:80;
#     server_name yourdomain.com www.yourdomain.com;
#
#     # Redirect all HTTP to HTTPS
#     return 301 https://$server_name$request_uri;
# }
